HOW TO COMPILE JACK USING WAF AND MINGW
=======================================


Rev. 0 - 2019-08-28 - First version
Rev. 1 - 2019-08-30 - Update guide to reflect patched wscripts
Rev. 2 - 2019-08-31 - Add instructions for compiling ASIO
Rev. 3 - 2019-09-01 - Update guide to reflect metadata patch



About
-----

This guide contains detailed instructions for building JACK on a modern MinGW
installation. It was conceived as the starting point for unifying the JACK build
process across all platforms.

As this is work in progress, there are still a couple of caveats:

- Asynchronous mode is unusable with low latencies
- A waf script for building JackRouter is missing
- Lots of real world testing is needed



Creating the development environment
------------------------------------

This guide uses MSYS2 as the toolchain, it can be found at https://www.msys2.org/
It comes as a handy installer called msys2-x86_64-{version}.exe. Once installed:

- Open "MSYS2 MinGW 64-bit terminal" from the MSYS2 start menu shortcuts

- Upgrade all MSYS2 packages. Running the following command might require
closing the MSYS2 window at a certain point and then restarting

pacman -Suy

- Install needed packages

pacman -S mingw-w64-x86_64-toolchain patch autoconf make \
gettext-devel automake libtool pkgconfig p7zip unzip git python

- Replace the GCC compiler with a version configured for SJLJ exceptions, as
instructed by the original Windows build instructions (windows/README)

Prebuilt binaries can be found at
https://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/

Look for "x86_64-posix-sjlj" under "MinGW-W64 GCC-{version}", the file should be
called x86_64-{version}-release-posix-sjlj-rt_v6-rev0.7z

Or just download from a direct link (GCC 8.1.0):

wget https://downloads.sourceforge.net/project/mingw-w64/Toolchains%20targetting%20Win64/Personal%20Builds/mingw-builds/8.1.0/threads-posix/sjlj/x86_64-8.1.0-release-posix-sjlj-rt_v6-rev0.7z

Once downloaded:

p7zip -d x86_64-8.1.0-release-posix-sjlj-rt_v6-rev0.7z

That will decompress to a folder called mingw64 in the working directory.
Now replace the files from the previous mingw-w64-x86_64-toolchain package
installation:

mv /mingw64 /mingw64.pacman
mv mingw64 /

Make sure GCC still runs and it is the version we need:

$ gcc --version
gcc.exe (x86_64-posix-sjlj-rev0, Built by MinGW-W64 project) {version}



Preparing JACK dependencies
---------------------------

There are prebuilt MinGW binaries for all the libraries that can be installed
using the pacman package manager, but since we are using a compiler that is not
the default version shipped by MinGW, it seems better idea to build from source
to avoid any linker and runtime issues. A good technical explanation and/or
evidence for this statement is currently missing from this guide.

Fortunately there are PKGBUILD files for doing so together with a nice guide at
https://github.com/msys2/MINGW-packages

git clone https://github.com/msys2/MINGW-packages.git

cd MINGW-packages/mingw-w64-{libname}-git
MINGW_INSTALLS=mingw64 makepkg-mingw -sLf
pacman -U mingw-w64-{libname}-git-{suffix}.pkg.tar.xz

Repeat procedure for each library replacing {libname} with the appropriate name
and {suffix} with whatever the above process created.

db
libsndfile
libsamplerate

Some libraries like libsndfile and libsamplerate will ask for installing extra
dependencies, it is ok to do so. The following need to be built in order:

libtre
libsystre

libsystre is a wrapper around libtre that allows including <regex.h> later.
Before building it adjust the includes path, it can be unset afterwards:

export C_INCLUDE_PATH=/mingw64/include

Finally for portaudio the Steinberg ASIO SDK should be manually downloaded.
It can be found at https://www.steinberg.net/en/company/developers.html. The waf
script will later check if the SDK is present at /opt/asiosdk

wget https://www.steinberg.net/asiosdk -O /tmp/asiosdk.zip
unzip /tmp/asiosdk.zip -d /tmp
mv /tmp/asiosdk_{version}_{date} /opt/asiosdk

The PKGBUILD description file needs to be patched so configure is called with
the necessary flags for ASIO:

--with-asiodir=/opt/asiosdk   <- new option     
--with-winapi=wmme,directx,wasapi,vdmks,asio   <- append 'asio' to existing

Currently the shared library version of portaudio fails to build, a further
patch is needed so only the static version is generated. Comment out lines
[61-75], [82-83] from PKGBUILD.



Compiling JACK
--------------

- Clone repo

git clone https://github.com/jackaudio/jack2

- Build and install

cd jack2
./waf configure --prefix=/opt/jack && ./waf -p install

The resulting files can be found at /c/opt/jack/bin, or c:\msys64\opt\jack\bin



Running and distributing
------------------------

Make sure the following DLLs are distributed together with the JACK binaries.
They can be found in c:\msys64\mingw64\bin:

libstdc++-6.dll
libgcc_s_sjlj-1.dll
libwinpthread-1.dll
libtre-5.dll
libsystre-0.dll
libdb-6.0.dll
libsndfile-1.dll
libsamplerate-0.dll

To enable JACK-enabled applications talk to the freshly built server, copy the
following DLLs to c:\windows (that is what the current official 1.9.11 installer
for Windows does, needs to be improved):

libjackserver-0.dll   (rename to libjackserver64.dll)
libjack-0.dll         (rename to libjack64.dll)
libgcc_s_sjlj-1.dll
libwinpthread-1.dll
libtre-5.dll
libsystre-0.dll

Tested working clients:
Ardour
Bitwig Studio
QJackCtl

Example of starting the JACK server including MIDI support for a Focusrite USB
audio device using ASIO:
jackd -R -S -X winmme -d portaudio -p 32 -r 48000 -d "ASIO::Focusrite USB ASIO"



Development tools and links
---------------------------

http://www.dependencywalker.com/
https://docs.microsoft.com/en-us/sysinternals/downloads/procmon
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/gflags
https://blogs.msdn.microsoft.com/junfeng/2006/11/20/debugging-loadlibrary-failures/
https://stackoverflow.com/questions/15852677/static-and-dynamic-shared-linking-with-mingw
https://github.com/EddieRingle/portaudio/blob/master/src/hostapi/asio/ASIO-README.txt
